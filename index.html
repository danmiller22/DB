<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>US Team Fleet</title>
<meta name="color-scheme" content="dark only">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
<style>
:root{--glass:rgba(255,255,255,.06);--stroke:rgba(255,255,255,.18);--text:#e8eef7;--muted:#9fb3c8;--accent:#4da3ff;--radius:16px}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;color:var(--text);font:15px/1.55 -apple-system,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;background:#05070b}
.wrap{padding:24px 32px}
.brand{display:flex;align-items:center;gap:12px}
.brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px var(--accent)}
h1{margin:0;font-size:28px;font-weight:800;background:linear-gradient(90deg,#eef5ff,#8ec5ff);-webkit-background-clip:text;background-clip:text;color:transparent}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
.card{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,.03));border:1px solid var(--stroke);border-radius:16px;padding:16px}
.kpi{grid-column:1 / -1;display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.kpi-label{color:var(--muted);font-size:13px}.kpi-value{font-size:28px;font-weight:700;margin-top:6px}
.chart{grid-column:1 / span 12}
.table{grid-column:1 / span 12}.tbl{width:100%;overflow:auto;border-radius:12px}
.tbl table{width:100%;border-collapse:separate;border-spacing:0}
.tbl th,.tbl td{padding:10px 12px;white-space:nowrap;border-bottom:1px solid rgba(255,255,255,.06)}
.tbl th{position:sticky;top:0;background:rgba(255,255,255,.05);text-align:left;color:#cfe1f4;font-weight:600}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05)}
.badge.open{color:#ffd3a8;border-color:#ffd3a888}.badge.closed{color:#a4f3c2;border-color:#a4f3c288}
.tools{display:flex;gap:8px;align-items:center}
.tools input{min-width:340px;padding:12px 16px;border-radius:18px;border:1px solid rgba(255,255,255,.28);background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.08));color:#e8eef7}
.tools button{padding:12px 18px;border-radius:18px;border:1px solid rgba(255,255,255,.34);background:linear-gradient(180deg,rgba(255,255,255,.32),rgba(255,255,255,.10));color:#e8eef7}
#debug{display:none;white-space:pre-wrap;background:#2b1111;border:1px solid #ff9b9b;color:#ffdede;border-radius:12px;padding:12px;margin:12px 0}
</style>
</head>
<body>
<header class="wrap"><div class="brand"><span class="dot"></span><h1>US Team Fleet</h1></div></header>

<main class="wrap grid">
  <section class="kpi">
    <div class="card"><div class="kpi-label">Total Spend</div><div class="kpi-value" id="kpi-total">$0</div></div>
    <div class="card"><div class="kpi-label">Open Tickets</div><div class="kpi-value" id="kpi-open">0</div></div>
    <div class="card"><div class="kpi-label">Vendors</div><div class="kpi-value" id="kpi-vendors">0</div></div>
  </section>

  <section class="card chart">
    <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px">
      <h2 style="margin:0;font-size:16px">Spend over time</h2><div style="color:#9fb3c8;font-size:12px">by month</div>
    </div>
    <canvas id="lineChart" height="220"></canvas>
  </section>

  <section class="card table">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 style="margin:0;font-size:16px">All records <span id="count" style="color:#9fb3c8;font-size:12px"></span></h2>
      <div class="tools"><input id="q" type="search" placeholder="Search: unit, vendor, category, type, notes"/><button id="go" type="button">Search</button></div>
    </div>
    <div id="debug"></div>
    <div class="tbl" id="tbl"></div>
  </section>
</main>

<script>
dayjs.extend(dayjs_plugin_customParseFormat);

// ---- CONFIG ----
const SHEET_ID='1QiFjfGky5vNBPf9WCPNkvszjJXH9413GecYzioSO32Q';
const GID='1435752205';

// 3 источника CSV, используем первый успешно сработавший
const SOURCES=[
  // 1) gviz -> csv
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&gid=${GID}`,
  // 2) прямой экспорт
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${GID}`,
  // 3) publish-to-web (если включено)
  `https://docs.google.com/spreadsheets/d/${SHEET_ID}/pub?gid=${GID}&single=true&output=csv`
];

const CURRENCY='USD';
const money=n=>new Intl.NumberFormat('en-US',{style:'currency',currency:CURRENCY,maximumFractionDigits:2}).format(n||0);

// ---- Robust fetch with debug ----
async function fetchCSV(){
  let lastErr=null, lastBody='';
  for(const url of SOURCES){
    try{
      const r=await fetch(url,{cache:'no-store',mode:'cors'});
      const t=await r.text();
      if(r.ok && /^[^\r\n]*Date,Type,Unit,Category,Repair,Details,Vendor,Total,/.test(t.trim())){
        return t;
      }
      lastErr=`HTTP ${r.status} on ${url}`;
      lastBody=t.slice(0,600);
    }catch(e){ lastErr=String(e); }
  }
  showDebug(`${lastErr}\n\n${lastBody}`);
  throw new Error('CSV not available');
}

function showDebug(msg){
  const box=document.getElementById('debug'); box.style.display='block'; box.textContent=`Debug:\n${msg}`;
}

// ---- CSV parser (quotes-safe) ----
function parseCsv(csv){
  const rows=[]; let row=[], cell='', q=false;
  const push=()=>{row.push(cell);cell='';}, nl=()=>{rows.push(row);row=[];};
  for(let i=0;i<csv.length;i++){
    const ch=csv[i];
    if(ch==='"'){ q=!q; continue; }
    if(ch===',' && !q){ push(); continue; }
    if((ch==='\n' || ch==='\r') && !q){ if(cell!==''||row.length){ push(); nl(); } continue; }
    cell+=ch;
  }
  if(cell!==''||row.length){ push(); nl(); }
  return rows.filter(r=>r.length);
}

// ---- Normalize to A–M only ----
function normalize(table){
  const hdr=table[0].map(h=>h.trim());
  const need=['Date','Type','Unit','Category','Repair','Details','Vendor','Total','Paid By','Paid?','Reported By','Status','Notes'];
  // карта индексов
  const idx={}; need.forEach(n=>idx[n]=hdr.indexOf(n));
  const get=(r,n)=>{const i=idx[n]; return i>=0 && r[i]!=null ? String(r[i]).trim() : '';};
  const parseAmount=v=>{ if(v==null) return 0; const s=String(v).replace(/[^0-9.,-]+/g,'').replace(/(\d),(?=\d{3}\b)/g,'$1').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };
  const parseDate=v=>{ if(!v) return null; const d=dayjs(v,['YYYY-MM-DD','M/D/YYYY','MM/DD/YYYY','D.M.YYYY','DD.MM.YYYY'],true); return d.isValid()? d.toDate(): null; };
  return table.slice(1).map(r=>({
    date: parseDate(get(r,'Date')),
    ym: (d=>d? dayjs(d).format('YYYY-MM'): null)(parseDate(get(r,'Date'))),
    type:get(r,'Type'), unit:get(r,'Unit'), category:get(r,'Category'),
    repair:get(r,'Repair'), details:get(r,'Details'), vendor:get(r,'Vendor'),
    total: parseAmount(get(r,'Total')),
    paid_by:get(r,'Paid By'), paid:get(r,'Paid?').toLowerCase(),
    reported_by:get(r,'Reported By'), status:get(r,'Status'), notes:get(r,'Notes')
  }));
}

function keepValid(rows){
  return rows.filter(r =>
    r.date || r.unit || r.vendor || r.category || r.type || r.repair || r.details || r.notes ||
    (Number.isFinite(r.total) && r.total!==0) || (r.status && r.status!=='')
  );
}

function aggregate(rows){
  const byMonth=new Map(); rows.forEach(r=>{ if(r.ym) byMonth.set(r.ym,(byMonth.get(r.ym)||0)+r.total); });
  const months=[...byMonth.keys()].sort(); const monthSeries=months.map(m=>byMonth.get(m));
  const byVendor=new Map(); rows.forEach(r=>{ const k=(r.vendor||'').trim(); if(!k) return; byVendor.set(k,(byVendor.get(k)||0)+r.total); });
  const totalSpend=rows.reduce((s,r)=>s+(Number.isFinite(r.total)?r.total:0),0);
  const openCount=rows.filter(r=> (r.status||'').toLowerCase()!=='closed' && r.status!=='').length;
  const vendorCount=byVendor.size;
  return {months,monthSeries,totalSpend,openCount,vendorCount};
}

function renderKPI(A){
  animateNum(document.getElementById('kpi-total'),A.totalSpend,money);
  animateNum(document.getElementById('kpi-open'),A.openCount,v=>v.toFixed(0));
  document.getElementById('kpi-vendors').textContent=A.vendorCount;
}
function animateNum(el,val,fmt){const t0=performance.now(),dur=800;function f(t){const k=Math.min((t-t0)/dur,1);el.textContent=fmt(val*(1-Math.pow(1-k,3))); if(k<1)requestAnimationFrame(f);}requestAnimationFrame(f);}

function renderLine(A){
  const ctx=document.getElementById('lineChart').getContext('2d'); if(window._line) window._line.destroy();
  window._line=new Chart(ctx,{type:'line',data:{labels:A.months,datasets:[{label:'Spend',data:A.monthSeries,borderColor:'#4da3ff',borderWidth:2.5,pointRadius:0,tension:.35,fill:true,
    backgroundColor:c=>{const g=c.chart.ctx.createLinearGradient(0,c.chart.chartArea.bottom,0,c.chart.chartArea.top);g.addColorStop(0,'rgba(77,163,255,0)');g.addColorStop(.6,'rgba(77,163,255,.18)');g.addColorStop(1,'rgba(77,163,255,.28)');return g;}}]},
    options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{color:'#9fb3c8'}},y:{grid:{color:'rgba(255,255,255,.06)'},ticks:{color:'#9fb3c8'},beginAtZero:true}}});
}

function renderTable(rows){
  const el=document.getElementById('tbl');
  const t=document.createElement('table'); const th=document.createElement('thead');
  th.innerHTML=`<tr><th>Date</th><th>Unit</th><th>Vendor</th><th>Category</th><th>Type</th><th>Total</th><th>Status</th><th>Notes</th></tr>`;
  t.appendChild(th);
  const tb=document.createElement('tbody');
  rows.slice().reverse().forEach(r=>{
    const tr=document.createElement('tr');
    const date=r.date?dayjs(r.date).format('YYYY-MM-DD'):'—';
    const statusClass=(r.status||'').toLowerCase()==='closed'?'closed':'open';
    tr.innerHTML=`<td>${date}</td><td>${esc(r.unit)}</td><td>${esc(r.vendor)}</td><td>${esc(r.category)}</td><td>${esc(r.type)}</td><td>${money(r.total)}</td><td><span class="badge ${statusClass}">${esc(r.status||'—')}</span></td><td>${esc(r.notes||'')}</td>`;
    tb.appendChild(tr);
  });
  t.appendChild(tb);
  el.innerHTML=''; el.appendChild(t);
  document.getElementById('count').textContent=`(${rows.length})`;
}
const esc=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');

(async function init(){
  try{
    const csv=await fetchCSV();
    const table=parseCsv(csv);
    const rows=keepValid(normalize(table)).sort((a,b)=>(a.date?+a.date:0)-(b.date?+b.date:0));
    const A=aggregate(rows);
    renderKPI(A); renderLine(A);

    let filtered=rows;
    const q=document.getElementById('q'); const go=document.getElementById('go');
    const apply=()=>{ const needle=q.value.trim().toLowerCase();
      filtered=!needle?rows:rows.filter(r=>{
        const dateHit=r.date?dayjs(r.date).format('YYYY-MM-DD').includes(needle):false;
        return ['unit','vendor','category','type','notes','status','details','repair','paid_by']
          .some(k=>String(r[k]||'').toLowerCase().includes(needle)) || dateHit || String(r.total).includes(needle);
      });
      renderTable(filtered);
    };
    go.addEventListener('click',apply); q.addEventListener('keydown',e=>{ if(e.key==='Enter') apply(); });
    renderTable(filtered);
  }catch(e){
    showDebug(String(e));
    document.getElementById('tbl').innerHTML = `<div style="padding:12px;color:#ffbdbd">Data load error. See Debug box above.</div>`;
    console.error(e);
  }
})();
</script>
</body>
</html>
