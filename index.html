<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>US Team Fleet</title>
<meta name="color-scheme" content="dark only">
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
<style>
:root{--glass:rgba(255,255,255,.06);--stroke:rgba(255,255,255,.18);--text:#e8eef7;--muted:#9fb3c8;--accent:#4da3ff;--radius:16px;--blur:20px}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;color:var(--text);font:15px/1.55 -apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Roboto,Arial,sans-serif;background:#05070b}
.bg::before{content:"";position:fixed;inset:-220vmax;z-index:0;pointer-events:none;background:
radial-gradient(60vmax 60vmax at -10% 110%, rgba(80,150,255,.90) 0%, rgba(80,150,255,.15) 60%, transparent 72%),
radial-gradient(55vmax 55vmax at 110% -10%, rgba(170,210,255,.85) 0%, rgba(170,210,255,.28) 55%, transparent 72%),
radial-gradient(52vmax 52vmax at 115% 115%, rgba(100,170,255,.80) 0%, rgba(100,170,255,.18) 58%, transparent 72%),
radial-gradient(20vmax 20vmax at 6% 18%, rgba(120,190,255,.90) 0%, rgba(120,190,255,.30) 55%, transparent 72%),
radial-gradient(45vmax 35vmax at 55% 38%, rgba(255,255,255,.12) 0%, rgba(255,255,255,.06) 35%, transparent 70%);
filter:blur(50px) saturate(185%);animation:drift 60s ease-in-out infinite alternate}
@keyframes drift{0%{transform:translate3d(-2%,-1%,0) scale(1.02)}100%{transform:translate3d(2%,1.2%,0) scale(1.06)}}
.wrap{position:relative;z-index:1;padding:24px 32px}
.brand{display:flex;align-items:center;gap:12px}
.brand .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px var(--accent)}
h1{margin:0;font-size:28px;font-weight:800;background:linear-gradient(90deg,#eef5ff,#8ec5ff);-webkit-background-clip:text;background-clip:text;color:transparent}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px;min-height:calc(100vh - 160px)}
.card{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,.03));border:1px solid var(--stroke);border-radius:16px;padding:16px;backdrop-filter:blur(var(--blur)) saturate(160%);box-shadow:inset 0 1px 0 rgba(255,255,255,.08),0 8px 30px rgba(0,0,0,.35)}
.kpi{grid-column:1 / -1;display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
.kpi-label{color:var(--muted);font-size:13px}.kpi-value{font-size:28px;font-weight:700;margin-top:6px}
.chart{grid-column:1 / span 12}
.table{grid-column:1 / span 12}
.tbl{width:100%;overflow:auto;border-radius:12px}
.tbl table{width:100%;border-collapse:separate;border-spacing:0}
.tbl th,.tbl td{padding:10px 12px;white-space:nowrap;border-bottom:1px solid rgba(255,255,255,.06)}
.tbl th{position:sticky;top:0;background:rgba(255,255,255,.05);text-align:left;color:#cfe1f4;font-weight:600}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.05)}
.badge.open{color:#ffd3a8;border-color:#ffd3a888}.badge.closed{color:#a4f3c2;border-color:#a4f3c288}
.tools{display:flex;gap:8px;align-items:center}
.tools input{min-width:340px;padding:12px 16px;border-radius:18px;border:1px solid rgba(255,255,255,.28);background:linear-gradient(180deg,rgba(255,255,255,.22),rgba(255,255,255,.08));color:#e8eef7}
.tools button{padding:12px 18px;border-radius:18px;border:1px solid rgba(255,255,255,.34);background:linear-gradient(180deg,rgba(255,255,255,.32),rgba(255,255,255,.10));color:#e8eef7;cursor:pointer}
#debug{display:none;white-space:pre-wrap;background:#2b1111;border:1px solid #ff9b9b;color:#ffdede;border-radius:12px;padding:12px;margin:12px 0}
.hint{color:#9fb3c8;font-size:12px}
</style>
</head>
<body>
<div class="bg"></div>
<header class="wrap"><div class="brand"><span class="dot"></span><h1>US Team Fleet</h1></div></header>

<main class="wrap grid">
  <section class="kpi">
    <div class="card"><div class="kpi-label">Total Spend</div><div class="kpi-value" id="kpi-total">$0</div></div>
    <div class="card"><div class="kpi-label">Open Tickets</div><div class="kpi-value" id="kpi-open">0</div></div>
    <div class="card"><div class="kpi-label">Vendors</div><div class="kpi-value" id="kpi-vendors">0</div></div>
  </section>

  <section class="card chart">
    <div style="display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px">
      <h2 style="margin:0;font-size:16px">Spend over time</h2><div class="hint">by month</div>
    </div>
    <canvas id="lineChart" height="220"></canvas>
  </section>

  <section class="card table">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <h2 style="margin:0;font-size:16px">All records <span id="count" class="hint"></span></h2>
      <div class="tools"><input id="q" type="search" placeholder="Search: unit, vendor, category, type, notes"/><button id="go" type="button">Search</button></div>
    </div>
    <div id="debug"></div>
    <div class="tbl" id="tbl"></div>
  </section>
</main>

<script>
dayjs.extend(dayjs_plugin_customParseFormat);

// ===== CONFIG =====
const SHEET_ID = '1QiFjfGky5vNBPf9WCPNkvszjJXH9413GecYzioSO32Q';
const GID      = '1435752205';

// 1) Основной путь: GViz JSONP (обходит CORS) и тянет только A–M
const TQ = encodeURIComponent("select A,B,C,D,E,F,G,H,I,J,K,L,M where A is not null or C is not null or G is not null or H is not null or L is not null");
const GVIZ_JSONP = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${GID}&tq=${TQ}`;

// 2) Опциональный fallback: если позже опубликуешь как CSV — подставь сюда publish-URL
const OPTIONAL_PUBLISHED_CSV = ""; // пример: 'https://docs.google.com/spreadsheets/d/.../pub?gid=1435752205&single=true&output=csv'

const fmtMoney = n => new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:2}).format(n||0);

// ===== DATA LOADERS =====

// JSONP загрузка GViz
function loadGVizJSONP(src, timeout=12000){
  return new Promise((resolve,reject)=>{
    let done=false;
    const tid=setTimeout(()=>{ if(done) return; done=true; cleanup(); reject(new Error('GViz timeout')); }, timeout);

    // перехват setResponse
    window.google=window.google||{};
    window.google.visualization=window.google.visualization||{};
    window.google.visualization.Query=window.google.visualization.Query||{};
    const prev=window.google.visualization.Query.setResponse;
    window.google.visualization.Query.setResponse=(payload)=>{
      if(done) return;
      done=true; clearTimeout(tid); cleanup(); resolve(payload);
      window.google.visualization.Query.setResponse = prev || (x=>x);
    };

    function cleanup(){ s.remove(); }
    const s=document.createElement('script');
    s.src=src+'&cacheBust='+(Date.now());
    s.onerror=()=>{ if(done) return; done=true; clearTimeout(tid); cleanup(); reject(new Error('GViz script error')); };
    document.body.appendChild(s);
  });
}

// CSV publish fallback
async function loadPublishedCSV(){
  if(!OPTIONAL_PUBLISHED_CSV) throw new Error('no-published-url');
  const r=await fetch(OPTIONAL_PUBLISHED_CSV+'&_='+Date.now(),{cache:'no-store',mode:'cors'});
  const t=await r.text();
  if(!r.ok || !/^Date,Type,Unit,Category,Repair,Details,Vendor,Total,/.test(t.trim())) {
    throw new Error('not-csv');
  }
  return t;
}

// CSV parser
function parseCsv(text){
  const rows=[]; let row=[], cell='', q=false;
  const push=()=>{row.push(cell);cell='';}, nl=()=>{rows.push(row);row=[];};
  for(let i=0;i<text.length;i++){
    const ch=text[i];
    if(ch==='"'){ q=!q; continue; }
    if(ch===',' && !q){ push(); continue; }
    if((ch==='\n'||ch==='\r') && !q){ if(cell!==''||row.length){ push(); nl(); } continue; }
    cell+=ch;
  }
  if(cell!==''||row.length){ push(); nl(); }
  return rows.filter(r=>r.length);
}

// ===== PARSERS =====
function parseGVizPayload(j){
  if(j.status!=='ok') throw new Error('GViz status != ok');
  const cols=j.table.cols.map(c=>(c.label||c.id||'').trim());
  return j.table.rows.map(r=>{
    const o={};
    (r.c||[]).forEach((c,i)=>{
      let v=c?c.v:'';
      if(typeof v==='string' && /^Date\(\d+,\d+,\d+\)$/.test(v)){
        const m=v.match(/^Date\((\d+),(\d+),(\d+)\)$/); if(m) v=new Date(+m[1],+m[2],+m[3]);
      }
      o[cols[i]||`col${i}`]=v;
    });
    return o;
  });
}

function normalizeObjRows(rows){
  const parseAmount=v=>{ if(v==null) return 0; const s=String(v).replace(/[^0-9.,-]+/g,'').replace(/(\d),(?=\d{3}\b)/g,'$1').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };
  return rows.map(r=>{
    const raw=r['Date']||'';
    const d=(raw instanceof Date)? dayjs(raw) : dayjs(raw,['YYYY-MM-DD','M/D/YYYY','MM/DD/YYYY','D.M.YYYY','DD.MM.YYYY'],true);
    const ok=d.isValid();
    return {
      date: ok? d.toDate(): null,
      ym:   ok? d.format('YYYY-MM'): null,
      type:r['Type']||'', unit:r['Unit']||'', category:r['Category']||'',
      repair:r['Repair']||'', details:r['Details']||'',
      vendor:r['Vendor']||'', total:parseAmount(r['Total']),
      paid_by:r['Paid By']||'', paid:(r['Paid?']||'').toLowerCase(),
      reported_by:r['Reported By']||'', status:(r['Status']||'').toString().trim(),
      notes:r['Notes']||''
    };
  });
}

function normalizeCsvTable(table){
  const hdr=table[0].map(h=>h.trim());
  const idx=n=>hdr.indexOf(n);
  const I={Date:idx('Date'),Type:idx('Type'),Unit:idx('Unit'),Category:idx('Category'),
           Repair:idx('Repair'),Details:idx('Details'),Vendor:idx('Vendor'),Total:idx('Total'),
           PaidBy:idx('Paid By'),Paid:idx('Paid?'),ReportedBy:idx('Reported By'),Status:idx('Status'),Notes:idx('Notes')};
  const get=(r,i)=> (i>=0 && r[i]!=null)? String(r[i]).trim():'';
  const parseAmount=v=>{ if(v==null) return 0; const s=String(v).replace(/[^0-9.,-]+/g,'').replace(/(\d),(?=\d{3}\b)/g,'$1').replace(',','.'); const n=parseFloat(s); return isNaN(n)?0:n; };
  const parseDate=v=>{ if(!v) return null; const d=dayjs(v,['YYYY-MM-DD','M/D/YYYY','MM/DD/YYYY','D.M.YYYY','DD.MM.YYYY'],true); return d.isValid()? d.toDate(): null; };
  return table.slice(1).map(r=>({
    date: parseDate(get(r,I.Date)), ym: (d=>d?dayjs(d).format('YYYY-MM'):null)(parseDate(get(r,I.Date))),
    type:get(r,I.Type), unit:get(r,I.Unit), category:get(r,I.Category),
    repair:get(r,I.Repair), details:get(r,I.Details), vendor:get(r,I.Vendor),
    total:parseAmount(get(r,I.Total)), paid_by:get(r,I.PaidBy), paid:get(r,I.Paid).toLowerCase(),
    reported_by:get(r,I.ReportedBy), status:get(r,I.Status), notes:get(r,I.Notes)
  }));
}

function keepValid(a){
  return a.filter(r =>
    r.date || r.unit || r.vendor || r.category || r.type || r.repair || r.details || r.notes ||
    (Number.isFinite(r.total)&&r.total!==0) || (r.status&&r.status!=='')
  );
}

// ===== AGG + RENDER =====
function aggregate(rows){
  const byM=new Map(); rows.forEach(r=>{ if(r.ym) byM.set(r.ym,(byM.get(r.ym)||0)+r.total); });
  const months=[...byM.keys()].sort(); const series=months.map(m=>byM.get(m));
  const byV=new Map(); rows.forEach(r=>{ const k=(r.vendor||'').trim(); if(!k) return; byV.set(k,(byV.get(k)||0)+r.total); });
  return {
    months, series,
    total: rows.reduce((s,r)=>s+(Number.isFinite(r.total)?r.total:0),0),
    open: rows.filter(r=> (r.status||'').toLowerCase()!=='closed' && r.status!=='').length,
    vendors: byV.size
  };
}

function animate(el,val,fmt){const t0=performance.now(),dur=900;function f(t){const k=Math.min((t-t0)/dur,1);el.textContent=fmt(val*(1-Math.pow(1-k,3))); if(k<1)requestAnimationFrame(f);}requestAnimationFrame(f);}
function renderKPI(a){animate(document.getElementById('kpi-total'),a.total,fmtMoney);animate(document.getElementById('kpi-open'),a.open,v=>v.toFixed(0));document.getElementById('kpi-vendors').textContent=a.vendors;}
function renderLine(a){
  const ctx=document.getElementById('lineChart').getContext('2d'); if(window._line) window._line.destroy();
  window._line=new Chart(ctx,{type:'line',data:{labels:a.months,datasets:[{label:'Spend',data:a.series,borderColor:'#4da3ff',borderWidth:2.5,pointRadius:0,tension:.35,fill:true,
    backgroundColor:c=>{const g=c.chart.ctx.createLinearGradient(0,c.chart.chartArea.bottom,0,c.chart.chartArea.top);g.addColorStop(0,'rgba(77,163,255,0)');g.addColorStop(.6,'rgba(77,163,255,.18)');g.addColorStop(1,'rgba(77,163,255,.28)');return g;}}]},
    options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false},ticks:{color:'#9fb3c8'}},y:{grid:{color:'rgba(255,255,255,.06)'},ticks:{color:'#9fb3c8'},beginAtZero:true}}});
}

function renderTable(rows){
  const el=document.getElementById('tbl'); const t=document.createElement('table'); const th=document.createElement('thead');
  th.innerHTML=`<tr><th>Date</th><th>Unit</th><th>Vendor</th><th>Category</th><th>Type</th><th>Total</th><th>Status</th><th>Notes</th></tr>`; t.appendChild(th);
  const tb=document.createElement('tbody');
  rows.slice().reverse().forEach(r=>{
    const d=r.date?dayjs(r.date).format('YYYY-MM-DD'):'—';
    const st=(r.status||'').toLowerCase()==='closed'?'closed':'open';
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${d}</td><td>${esc(r.unit)}</td><td>${esc(r.vendor)}</td><td>${esc(r.category)}</td><td>${esc(r.type)}</td><td>${fmtMoney(r.total)}</td><td><span class="badge ${st}">${esc(r.status||'—')}</span></td><td>${esc(r.notes||'')}</td>`;
    tb.appendChild(tr);
  });
  t.appendChild(tb); el.innerHTML=''; el.appendChild(t);
  document.getElementById('count').textContent=`(${rows.length})`;
}
const esc=s=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
function showDebug(msg){const b=document.getElementById('debug');b.style.display='block';b.textContent='Debug: '+msg;}

// ===== INIT =====
(async function(){
  try{
    // 1) JSONP GViz
    const payload = await loadGVizJSONP(GVIZ_JSONP);
    const rows = keepValid(normalizeObjRows(parseGVizPayload(payload))).sort((a,b)=>(a.date?+a.date:0)-(b.date?+b.date:0));
    const A=aggregate(rows); renderKPI(A); renderLine(A);
    hookSearch(rows); renderTable(rows);
  }catch(e1){
    // 2) Fallback: опубликованный CSV (если введёшь URL)
    try{
      const csv = await loadPublishedCSV();
      const table = parseCsv(csv);
      const rows = keepValid(normalizeCsvTable(table)).sort((a,b)=>(a.date?+a.date:0)-(b.date?+b.date:0));
      const A=aggregate(rows); renderKPI(A); renderLine(A);
      hookSearch(rows); renderTable(rows);
    }catch(e2){
      showDebug(String(e1)+' | '+String(e2));
      document.getElementById('tbl').innerHTML='<div style="padding:12px;color:#ffbdbd">Data load error. See Debug above.</div>';
      console.error(e1,e2);
    }
  }
})();

function hookSearch(rows){
  let filtered=rows;
  const q=document.getElementById('q'); const go=document.getElementById('go');
  const apply=()=>{ const needle=q.value.trim().toLowerCase();
    filtered=!needle?rows:rows.filter(r=>{
      const dateHit=r.date?dayjs(r.date).format('YYYY-MM-DD').includes(needle):false;
      return ['unit','vendor','category','type','notes','status','details','repair','paid_by']
        .some(k=>String(r[k]||'').toLowerCase().includes(needle)) || dateHit || String(r.total).includes(needle);
    });
    renderTable(filtered);
  };
  go.addEventListener('click',apply); q.addEventListener('keydown',e=>{ if(e.key==='Enter') apply(); });
}
</script>
</body>
</html>
